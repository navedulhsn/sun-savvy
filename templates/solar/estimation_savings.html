{% extends 'base.html' %}
{% load static %}

{% block title %}Step 4: Savings & ROI - Solar Estimation{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(180deg, #f5f5f7 0%, #ffffff 100%);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .estimation-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 60px 20px;
        padding-top: 160px;
    }

    .module-card {
        background: #ffffff;
        border-radius: 18px;
        padding: 40px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
        animation: fadeInUp 0.6s ease-out forwards;
    }

    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .module-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    }

    .module-title {
        font-size: 32px;
        font-weight: 600;
        letter-spacing: -0.01em;
        color: #1d1d1f;
        margin: 0;
    }

    .module-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        font-size: 20px;
        font-weight: 600;
        margin-right: 16px;
    }

    .status-badge {
        background: #34c759;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
    }

    .form-control, .form-select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d2d2d7;
        border-radius: 10px;
        font-size: 15px;
    }

    .btn {
        padding: 12px 24px;
        border-radius: 10px;
        font-weight: 500;
        font-size: 15px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #0071e3;
        color: white;
    }

    .btn-primary:hover {
        background: #0051d5;
    }

    .btn-success {
        background: #34c759;
        color: white;
    }

    .btn-success:hover {
        background: #28a745;
    }

    .btn-secondary {
        background: #f5f5f7;
        color: #1d1d1f;
    }

    .btn-outline-danger {
        background: transparent;
        color: #dc3545;
        border: 2px solid #dc3545;
    }

    .btn-outline-danger:hover {
        background: #dc3545;
        color: white;
    }

    .result-box {
        background: #f5f5f7;
        border-radius: 12px;
        padding: 32px;
    }

    .result-title {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 24px;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 24px;
    }

    .result-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    .result-item {
        background: white;
        padding: 20px;
        border-radius: 12px;
    }

    .result-label {
        font-size: 13px;
        color: #86868b;
        margin-bottom: 8px;
        font-weight: 500;
    }

    .result-value {
        font-size: 24px;
        font-weight: 600;
        color: #1d1d1f;
    }

    .navigation-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 32px;
        gap: 16px;
        flex-wrap: wrap;
    }

    .step-indicator {
        text-align: center;
        margin-bottom: 32px;
        color: #86868b;
        font-size: 15px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Mini Navigation Bar -->
{% include 'solar/estimation_nav.html' %}

<div class="estimation-container">
    <div class="step-indicator">
        Step {{ current_module }} of {{ total_modules }}
    </div>

    <div class="module-card">
        <div class="module-header">
            <h2 class="module-title">
                <span class="module-number">4</span>
                Savings & ROI Calculation
            </h2>
            {% if savings_roi_result %}
            <span class="status-badge">✓ Completed</span>
            {% endif %}
        </div>

        <!-- Disclaimer - Always visible until results are cleared -->
        {% if location_result and energy_result and roof_result %}
        <div id="estimation-disclaimer" class="alert alert-info alert-permanent" style="margin-bottom: 20px; padding: 15px; border-radius: 8px; background-color: #e7f3ff; border-left: 4px solid #0066cc; position: relative;">
            <div style="display: flex; align-items: start;">
                <i class="bi bi-info-circle" style="font-size: 20px; color: #0066cc; margin-right: 10px; margin-top: 2px;"></i>
                <div>
                    <strong style="color: #0066cc;">Disclaimer - Rough Estimation:</strong>
                    <p style="margin: 8px 0 0 0; color: #333; font-size: 14px;">
                        This is a <strong>rough estimation</strong> based on average Pakistani market rates (2024-2025). 
                        Actual costs may vary based on:
                    </p>
                    <ul style="margin: 8px 0 0 20px; color: #555; font-size: 13px;">
                        <li>Panel brand and quality (Standard, Medium, Large, Premium)</li>
                        <li>Installation complexity and location</li>
                        <li>Inverter type and capacity</li>
                        <li>Wiring and mounting requirements</li>
                        <li>Local market conditions and provider pricing</li>
                    </ul>
                    <p style="margin: 8px 0 0 0; color: #333; font-size: 14px;">
                        <strong>Please consult with certified solar installers for accurate quotations.</strong>
                    </p>
                </div>
            </div>
        </div>
        {% endif %}

        {% if not savings_roi_result %}
            {% if location_result and energy_result and roof_result %}
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="calculate_savings_roi">
                
                <div class="form-group">
                    <label class="form-label">Select Panel Option</label>
                    <select name="selected_panel_option" class="form-select" style="margin-bottom: 12px;">
                        {% for option in roof_result.panel_options %}
                        <option value="{{ forloop.counter0 }}">
                            {{ option.panel_type }} - {{ option.max_panels }} panels fit - PKR {{ option.cost_per_panel|floatformat:0 }}/panel - {{ option.panel_specs.power_watts }}W ({{ option.kw_per_panel|floatformat:2 }} kW)/panel
                        </option>
                        {% endfor %}
                    </select>
                    <div style="background: #f5f5f7; padding: 12px; border-radius: 8px; margin-top: 8px;">
                        <small class="text-muted" style="display: block; margin-bottom: 4px;"><strong>Panel Prices (Per Panel):</strong></small>
                        <small class="text-muted" style="display: block;">
                            • Standard Panel: PKR 15,000 per panel (250W / 0.25 kW per panel)<br>
                            • Medium Panel: PKR 20,000 per panel (400W / 0.40 kW per panel)<br>
                            • Large Panel: PKR 25,000 per panel (500W / 0.50 kW per panel)<br>
                            • Premium Panel: PKR 30,000 per panel (600W / 0.60 kW per panel)
                        </small>
                        <small class="text-muted" style="display: block; margin-top: 8px; font-style: italic;">
                            Prices are based on Pakistani market rates (2024-2025). Actual costs may vary based on brand, quality, and market conditions.
                        </small>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Electricity Rate (PKR/kWh) <small style="color: #86868b;">(Optional)</small></label>
                    <input type="number" name="electricity_rate" class="form-control" step="0.01" placeholder="Default: 33.6 PKR/kWh">
                    <small class="text-muted">Average electricity rate in Pakistan (varies by region and consumer type)</small>
                </div>

                <div class="navigation-buttons">
                    <div style="display: flex; gap: 12px;">
                        <a href="{% url 'estimation_roof' %}" class="btn btn-secondary" style="text-decoration: none;">
                            <i class="bi bi-arrow-left me-2"></i>Previous
                        </a>
                        <form method="post" style="margin: 0;">
                            {% csrf_token %}
                            <button type="submit" name="action" value="clear_all" class="btn btn-outline-danger" onclick="return confirm('Are you sure you want to clear all estimation data? This will reset everything to the beginning.');">
                                <i class="bi bi-trash me-2"></i>Clear All
                            </button>
                        </form>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-calculator me-2"></i>Calculate Savings & ROI
                    </button>
                </div>
            </form>
            {% else %}
            <div style="text-align: center; padding: 60px 20px; color: #86868b;">
                <i class="bi bi-lock" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                <p style="font-size: 17px; margin: 0;">Complete the previous modules to unlock financial analysis</p>
            </div>
            {% endif %}
        {% else %}
        <div class="result-box">
            <div class="result-title">
                <i class="bi bi-check-circle-fill text-success"></i>
                Financial Analysis Complete
            </div>
            <div class="result-grid">
                <div class="result-item">
                    <div class="result-label">System Capacity</div>
                    <div class="result-value">{{ savings_roi_result.system_capacity_kw|floatformat:2 }} <small style="font-size: 14px;">kW</small></div>
                </div>
                <div class="result-item">
                    <div class="result-label">Panels Needed</div>
                    <div class="result-value">{{ savings_roi_result.panels_needed }}</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Total Cost</div>
                    <div class="result-value">PKR {{ savings_roi_result.total_installation_cost|floatformat:0 }}</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Annual Savings</div>
                    <div class="result-value">PKR {{ savings_roi_result.annual_savings|floatformat:0 }}</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Payback Period</div>
                    <div class="result-value">{{ savings_roi_result.payback_period_years|floatformat:1 }} <small style="font-size: 14px;">years</small></div>
                </div>
                <div class="result-item">
                    <div class="result-label">ROI</div>
                    <div class="result-value" style="color: #34c759;">{{ savings_roi_result.roi_percentage|floatformat:1 }}%</div>
                </div>
            </div>
            
            <!-- Cost Breakdown Section -->
            <div style="background: #f8f9fa; border-radius: 12px; padding: 24px; margin-top: 24px;">
                <h3 style="font-size: 18px; font-weight: 600; color: #1d1d1f; margin-bottom: 16px;">Cost Breakdown</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <div style="background: white; padding: 16px; border-radius: 8px;">
                        <div style="font-size: 13px; color: #86868b; margin-bottom: 8px; font-weight: 500;">Panel Cost</div>
                        <div style="font-size: 20px; font-weight: 600; color: #1d1d1f;">PKR {{ savings_roi_result.panel_cost|floatformat:0 }}</div>
                    </div>
                    <div style="background: white; padding: 16px; border-radius: 8px;">
                        <div style="font-size: 13px; color: #86868b; margin-bottom: 8px; font-weight: 500;">Installation</div>
                        <div style="font-size: 20px; font-weight: 600; color: #1d1d1f;">PKR {{ savings_roi_result.installation_cost|floatformat:0 }}</div>
                    </div>
                    <div style="background: white; padding: 16px; border-radius: 8px;">
                        <div style="font-size: 13px; color: #86868b; margin-bottom: 8px; font-weight: 500;">Inverter</div>
                        <div style="font-size: 20px; font-weight: 600; color: #1d1d1f;">PKR {{ savings_roi_result.inverter_cost|floatformat:0 }}</div>
                    </div>
                    <div style="background: white; padding: 16px; border-radius: 8px;">
                        <div style="font-size: 13px; color: #86868b; margin-bottom: 8px; font-weight: 500;">Wiring</div>
                        <div style="font-size: 20px; font-weight: 600; color: #1d1d1f;">PKR {{ savings_roi_result.wiring_mounting_cost|floatformat:0 }}</div>
                    </div>
                    <div style="background: white; padding: 16px; border-radius: 8px;">
                        <div style="font-size: 13px; color: #86868b; margin-bottom: 8px; font-weight: 500;">Permits</div>
                        <div style="font-size: 20px; font-weight: 600; color: #1d1d1f;">PKR 0 <small style="font-size: 12px; color: #86868b;">(Pakistan free permit)</small></div>
                    </div>
                </div>
            </div>
            
            <div class="navigation-buttons">
                <div style="display: flex; gap: 12px;">
                    <a href="{% url 'estimation_roof' %}" class="btn btn-secondary" style="text-decoration: none;">
                        <i class="bi bi-arrow-left me-2"></i>Previous
                    </a>
                    <form method="post" style="margin: 0;">
                        {% csrf_token %}
                        <button type="submit" name="action" value="clear_savings_roi" class="btn btn-secondary">
                            <i class="bi bi-x-circle me-2"></i>Clear
                        </button>
                    </form>
                    <form method="post" style="margin: 0;">
                        {% csrf_token %}
                        <button type="submit" name="action" value="clear_all" class="btn btn-outline-danger" onclick="return confirm('Are you sure you want to clear all estimation data? This will reset everything to the beginning.');">
                            <i class="bi bi-trash me-2"></i>Clear All
                        </button>
                    </form>
                </div>
                <div style="display: flex; gap: 12px;">
                    {% if estimation_saved %}
                    <div style="padding: 12px 24px; background: #d4edda; color: #155724; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                        <i class="bi bi-check-circle-fill"></i>
                        <span>Saved to Dashboard</span>
                    </div>
                    {% else %}
                    <form method="post" style="margin: 0;">
                        {% csrf_token %}
                        <button type="submit" name="action" value="save_estimation" class="btn btn-success">
                            <i class="bi bi-save me-2"></i>Save to Dashboard
                        </button>
                    </form>
                    {% endif %}
                    <a href="{% url 'generate_estimation_report' %}" class="btn btn-primary" style="text-decoration: none;">
                        <i class="bi bi-download me-2"></i>Download Report
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Prevent disclaimer from auto-hiding
document.addEventListener('DOMContentLoaded', function() {
    const disclaimer = document.getElementById('estimation-disclaimer');
    if (disclaimer) {
        disclaimer.classList.remove('alert-dismissible', 'fade', 'show');
        disclaimer.style.display = 'block';
        disclaimer.style.opacity = '1';
        disclaimer.style.visibility = 'visible';
    }
});
</script>

{% endblock %}

