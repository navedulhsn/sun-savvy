{% extends 'base.html' %}
{% load static %}

{% block title %}Solar Estimation - SunSavvy{% endblock %}

{% block extra_css %}
<style>
    /* Apple-inspired Design */
    body {
        background: linear-gradient(180deg, #f5f5f7 0%, #ffffff 100%);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .estimation-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 60px 20px;
    }

    .page-header {
        text-align: center;
        margin-bottom: 80px;
    }

    .page-header h1 {
        font-size: 56px;
        font-weight: 600;
        letter-spacing: -0.02em;
        color: #1d1d1f;
        margin-bottom: 12px;
    }

    .page-header p {
        font-size: 21px;
        color: #86868b;
        font-weight: 400;
    }

    .module-section {
        margin-bottom: 100px;
        opacity: 0;
        animation: fadeInUp 0.6s ease-out forwards;
    }

    .module-section:nth-child(1) { animation-delay: 0.1s; }
    .module-section:nth-child(2) { animation-delay: 0.2s; }
    .module-section:nth-child(3) { animation-delay: 0.3s; }
    .module-section:nth-child(4) { animation-delay: 0.4s; }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .module-card {
        background: #ffffff;
        border-radius: 18px;
        padding: 40px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .module-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }

    .module-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    }

    .module-title {
        font-size: 32px;
        font-weight: 600;
        letter-spacing: -0.01em;
        color: #1d1d1f;
        margin: 0;
    }

    .module-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        font-size: 20px;
        font-weight: 600;
        margin-right: 16px;
    }

    .status-badge {
        padding: 8px 20px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
        background: #34c759;
        color: white;
    }

    .form-group {
        margin-bottom: 24px;
    }

    .form-label {
        font-size: 17px;
        font-weight: 500;
        color: #1d1d1f;
        margin-bottom: 8px;
        display: block;
    }

    .form-control, .form-select {
        width: 100%;
        padding: 14px 16px;
        font-size: 17px;
        border: 1px solid #d2d2d7;
        border-radius: 12px;
        background: #ffffff;
        transition: all 0.2s;
        font-family: inherit;
    }

    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 14px 32px;
        font-size: 17px;
        font-weight: 500;
        border-radius: 12px;
        color: white;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
        background: #f5f5f7;
        border: none;
        padding: 10px 20px;
        font-size: 15px;
        font-weight: 500;
        border-radius: 10px;
        color: #1d1d1f;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-secondary:hover {
        background: #e5e5e7;
    }

    .result-box {
        margin-top: 32px;
        padding: 32px;
        background: linear-gradient(135deg, #f5f5f7 0%, #ffffff 100%);
        border-radius: 16px;
        border: 1px solid rgba(102, 126, 234, 0.2);
        animation: slideDown 0.4s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .result-title {
        font-size: 20px;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .result-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .result-item {
        padding: 16px;
        background: white;
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .result-label {
        font-size: 13px;
        color: #86868b;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
    }

    .result-value {
        font-size: 24px;
        font-weight: 600;
        color: #1d1d1f;
    }

    .location-method-toggle {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        background: #f5f5f7;
        padding: 6px;
        border-radius: 12px;
    }

    .location-method-btn {
        flex: 1;
        padding: 12px 20px;
        border: none;
        background: transparent;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 500;
        color: #86868b;
        cursor: pointer;
        transition: all 0.2s;
    }

    .location-method-btn.active {
        background: white;
        color: #1d1d1f;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    #map-container {
        width: 100%;
        height: 400px;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 20px;
        border: 1px solid #d2d2d7;
    }

    .download-section {
        text-align: center;
        margin-top: 80px;
        padding: 60px 40px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 24px;
        color: white;
    }

    .download-section h2 {
        font-size: 40px;
        font-weight: 600;
        margin-bottom: 16px;
    }

    .download-section p {
        font-size: 19px;
        opacity: 0.9;
        margin-bottom: 32px;
    }

    .btn-download {
        background: white;
        color: #667eea;
        padding: 16px 40px;
        font-size: 17px;
        font-weight: 600;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 12px;
    }

    .btn-download:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    .hidden {
        display: none;
    }

    .appliance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .appliance-item {
        padding: 16px;
        background: #f5f5f7;
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .appliance-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-right: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div class="estimation-container">
    <div class="page-header">
        <h1>Solar Energy Estimation</h1>
        <p>Calculate your solar potential in four simple steps</p>
    </div>

    <!-- Module 1: Location Based Estimation -->
    <div class="module-section">
        <div class="module-card">
            <div class="module-header">
                <h2 class="module-title">
                    <span class="module-number">1</span>
                    Location Based Estimation
                </h2>
                {% if location_result %}
                <span class="status-badge">✓ Completed</span>
                {% endif %}
            </div>

            {% if not location_result %}
            <form method="post" id="location-form">
                {% csrf_token %}
                <input type="hidden" name="action" value="calculate_location">
                
                <div class="location-method-toggle">
                    <button type="button" class="location-method-btn active" data-method="map" onclick="switchLocationMethod('map'); return false;">
                        <i class="bi bi-map me-2"></i>Google Map
                    </button>
                    <button type="button" class="location-method-btn" data-method="coordinates" onclick="switchLocationMethod('coordinates'); return false;">
                        <i class="bi bi-geo-alt me-2"></i>Manual Input
                    </button>
                </div>

                <!-- Google Map Option -->
                <div id="map-option" class="location-option">
                    <div id="map-container"></div>
                    <input type="hidden" name="selected_lat" id="selected_lat" value="">
                    <input type="hidden" name="selected_lng" id="selected_lng" value="">
                </div>

                <!-- Manual Coordinates Option -->
                <div id="coordinates-option" class="location-option hidden">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Latitude</label>
                            <input type="number" name="latitude" class="form-control" step="0.000001" placeholder="e.g., 24.8607" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Longitude</label>
                            <input type="number" name="longitude" class="form-control" step="0.000001" placeholder="e.g., 67.0011" required>
                        </div>
                    </div>
                </div>

                <div class="form-group mt-3">
                    <label class="form-label">Address</label>
                    <input type="text" name="address" class="form-control" placeholder="Enter your address" required>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">City</label>
                        <input type="text" name="city" class="form-control" placeholder="Enter city" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">State/Province</label>
                        <input type="text" name="state" class="form-control" placeholder="Enter state" required>
                    </div>
                </div>

                <input type="hidden" name="location_method" id="location_method" value="map">

                <button type="submit" class="btn btn-primary mt-4">
                    Calculate Solar Potential
                </button>
            </form>
            {% else %}
            <div class="result-box">
                <div class="result-title">
                    <i class="bi bi-check-circle-fill text-success"></i>
                    Location Analysis Complete
                </div>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-label">Address</div>
                        <div class="result-value" style="font-size: 16px;">{{ location_result.address }}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">City, State</div>
                        <div class="result-value" style="font-size: 16px;">{{ location_result.city }}, {{ location_result.state }}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Solar Irradiance</div>
                        <div class="result-value">{{ location_result.irradiance|floatformat:2 }} <small style="font-size: 14px;">{{ location_result.irradiance_unit }}</small></div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Coordinates</div>
                        <div class="result-value" style="font-size: 14px;">{{ location_result.latitude|floatformat:4 }}, {{ location_result.longitude|floatformat:4 }}</div>
                    </div>
                </div>
                <form method="post" style="margin-top: 20px;">
                    {% csrf_token %}
                    <button type="submit" name="action" value="clear_location" class="btn-secondary">
                        <i class="bi bi-x-circle me-2"></i>Clear Results
                    </button>
                </form>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Module 2: Energy Consumption Estimation -->
    <div class="module-section">
        <div class="module-card">
            <div class="module-header">
                <h2 class="module-title">
                    <span class="module-number">2</span>
                    Energy Consumption Estimation
                </h2>
                {% if energy_result %}
                <span class="status-badge">✓ Completed</span>
                {% endif %}
            </div>

            {% if not energy_result %}
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="calculate_energy">
                
                <div class="form-group">
                    <label class="form-label">Select Your Appliances</label>
                    <div class="appliance-grid">
                        {% regroup appliances by category as category_list %}
                        {% for category in category_list %}
                            <div style="grid-column: 1 / -1; font-weight: 600; color: #1d1d1f; margin-top: 16px; margin-bottom: 8px;">
                                {{ category.grouper }}
                            </div>
                            {% for appliance in category.list %}
                            <div class="appliance-item">
                                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                    <input type="checkbox" name="appliance_{{ appliance.id }}" id="app_{{ appliance.id }}">
                                    <label for="app_{{ appliance.id }}" style="margin: 0; font-weight: 500;">
                                        {{ appliance.name }} <small style="color: #86868b;">({{ appliance.power_rating_watts }}W)</small>
                                    </label>
                                </div>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <input type="number" name="quantity_{{ appliance.id }}" class="form-control form-control-sm" placeholder="Quantity" value="1" min="1">
                                    </div>
                                    <div class="col-6">
                                        <input type="number" name="hours_{{ appliance.id }}" class="form-control form-control-sm" placeholder="Hours/Day" value="0" min="0" max="24" step="0.5">
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">
                    Calculate Energy Consumption
                </button>
            </form>
            {% else %}
            <div class="result-box">
                <div class="result-title">
                    <i class="bi bi-check-circle-fill text-success"></i>
                    Energy Consumption Calculated
                </div>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-label">Total Monthly Consumption</div>
                        <div class="result-value">{{ energy_result.total_monthly_kwh|floatformat:2 }} <small style="font-size: 14px;">kWh</small></div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Estimated Annual</div>
                        <div class="result-value" id="annual-consumption">{{ energy_result.total_monthly_kwh|floatformat:0 }} <small style="font-size: 14px;">kWh × 12</small></div>
                        <script>
                            (function() {
                                const monthly = {{ energy_result.total_monthly_kwh }};
                                const annual = monthly * 12;
                                document.getElementById('annual-consumption').innerHTML = annual.toFixed(0) + ' <small style="font-size: 14px;">kWh</small>';
                            })();
                        </script>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Appliances Selected</div>
                        <div class="result-value">{{ energy_result.appliance_details|length }}</div>
                    </div>
                </div>
                {% if energy_result.appliance_details %}
                <div style="margin-top: 24px;">
                    <div class="result-label" style="margin-bottom: 12px;">Appliance Breakdown</div>
                    <div style="background: white; border-radius: 12px; padding: 16px;">
                        {% for detail in energy_result.appliance_details %}
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.05);">
                            <span>{{ detail.appliance_name }} ({{ detail.quantity }}x, {{ detail.hours_per_day }}hrs/day)</span>
                            <strong>{{ detail.monthly_kwh|floatformat:2 }} kWh/month</strong>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                <form method="post" style="margin-top: 20px;">
                    {% csrf_token %}
                    <button type="submit" name="action" value="clear_energy" class="btn-secondary">
                        <i class="bi bi-x-circle me-2"></i>Clear Results
                    </button>
                </form>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Module 3: Roof Area Estimation -->
    <div class="module-section">
        <div class="module-card">
            <div class="module-header">
                <h2 class="module-title">
                    <span class="module-number">3</span>
                    Roof Area Estimation
                </h2>
                {% if roof_result %}
                <span class="status-badge">✓ Completed</span>
                {% endif %}
            </div>

            {% if not roof_result %}
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="calculate_roof">
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Rooftop Length (meters)</label>
                        <input type="number" name="rooftop_length" class="form-control" step="0.01" min="0" placeholder="Enter length" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Rooftop Width (meters)</label>
                        <input type="number" name="rooftop_width" class="form-control" step="0.01" min="0" placeholder="Enter width" required>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary mt-4">
                    Calculate Roof Area
                </button>
            </form>
            {% else %}
            <div class="result-box">
                <div class="result-title">
                    <i class="bi bi-check-circle-fill text-success"></i>
                    Roof Area Calculated
                </div>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-label">Dimensions</div>
                        <div class="result-value" style="font-size: 18px;">{{ roof_result.rooftop_length|floatformat:2 }}m × {{ roof_result.rooftop_width|floatformat:2 }}m</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Total Area</div>
                        <div class="result-value">{{ roof_result.rooftop_area|floatformat:2 }} <small style="font-size: 14px;">m²</small></div>
                    </div>
                </div>
                {% if roof_result.panel_options %}
                <div style="margin-top: 24px;">
                    <div class="result-label" style="margin-bottom: 12px;">Available Panel Options</div>
                    <div style="display: grid; gap: 12px;">
                        {% for option in roof_result.panel_options %}
                        <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>{{ option.panel_type }}</strong>
                                    <div style="font-size: 14px; color: #86868b; margin-top: 4px;">
                                        {{ option.max_panels }} panels • {{ option.total_capacity_kw|floatformat:2 }} kW
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 20px; font-weight: 600;">PKR {{ option.total_cost|floatformat:0 }}</div>
                                    {% if forloop.first %}
                                    <span style="font-size: 12px; color: #34c759; font-weight: 500;">Recommended</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                <form method="post" style="margin-top: 20px;">
                    {% csrf_token %}
                    <button type="submit" name="action" value="clear_roof" class="btn-secondary">
                        <i class="bi bi-x-circle me-2"></i>Clear Results
                    </button>
                </form>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Module 4: Savings & ROI -->
    <div class="module-section">
        <div class="module-card">
            <div class="module-header">
                <h2 class="module-title">
                    <span class="module-number">4</span>
                    Savings & ROI Calculation
                </h2>
                {% if savings_roi_result %}
                <span class="status-badge">✓ Completed</span>
                {% endif %}
            </div>

            {% if not savings_roi_result %}
                {% if location_result and energy_result and roof_result %}
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="calculate_savings_roi">
                    
                    <div class="form-group">
                        <label class="form-label">Select Panel Option</label>
                        <select name="selected_panel_option" class="form-select">
                            {% for option in roof_result.panel_options %}
                            <option value="{{ forloop.counter0 }}">
                                {{ option.panel_type }} ({{ option.total_capacity_kw|floatformat:2 }} kW) - PKR {{ option.total_cost|floatformat:0 }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Electricity Rate (PKR/kWh) <small style="color: #86868b;">(Optional)</small></label>
                        <input type="number" name="electricity_rate" class="form-control" step="0.01" placeholder="Default: 33.6 PKR/kWh">
                    </div>

                    <button type="submit" class="btn btn-primary">
                        Calculate Savings & ROI
                    </button>
                </form>
                {% else %}
                <div style="text-align: center; padding: 60px 20px; color: #86868b;">
                    <i class="bi bi-lock" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                    <p style="font-size: 17px; margin: 0;">Complete the previous modules to unlock financial analysis</p>
                </div>
                {% endif %}
            {% else %}
            <div class="result-box">
                <div class="result-title">
                    <i class="bi bi-check-circle-fill text-success"></i>
                    Financial Analysis Complete
                </div>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-label">System Capacity</div>
                        <div class="result-value">{{ savings_roi_result.system_capacity_kw|floatformat:2 }} <small style="font-size: 14px;">kW</small></div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Panels Needed</div>
                        <div class="result-value">{{ savings_roi_result.panels_needed }}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Total Cost</div>
                        <div class="result-value">PKR {{ savings_roi_result.total_installation_cost|floatformat:0 }}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Annual Savings</div>
                        <div class="result-value">PKR {{ savings_roi_result.annual_savings|floatformat:0 }}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Payback Period</div>
                        <div class="result-value">{{ savings_roi_result.payback_period_years|floatformat:1 }} <small style="font-size: 14px;">years</small></div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">ROI</div>
                        <div class="result-value" style="color: #34c759;">{{ savings_roi_result.roi_percentage|floatformat:1 }}%</div>
                    </div>
                </div>
                <form method="post" style="margin-top: 20px;">
                    {% csrf_token %}
                    <button type="submit" name="action" value="clear_savings_roi" class="btn-secondary">
                        <i class="bi bi-x-circle me-2"></i>Clear Results
                    </button>
                </form>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Download Report Section -->
    {% if all_complete %}
    <div class="download-section">
        <h2>Your Complete Solar Report</h2>
        <p>Download a comprehensive PDF report with all your estimation details</p>
        <a href="{% url 'generate_estimation_report' %}" class="btn-download">
            <i class="bi bi-download" style="font-size: 20px;"></i>
            Download Full Report
        </a>
    </div>
    {% endif %}
</div>

<script>
function switchLocationMethod(method) {
    document.querySelectorAll('.location-method-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.method === method) {
            btn.classList.add('active');
        }
    });
    
    document.getElementById('location_method').value = method;
    
    if (method === 'map') {
        document.getElementById('map-option').classList.remove('hidden');
        document.getElementById('coordinates-option').classList.add('hidden');
        if (typeof google !== 'undefined' && google.maps) {
            initMap();
        }
    } else {
        document.getElementById('map-option').classList.add('hidden');
        document.getElementById('coordinates-option').classList.remove('hidden');
    }
}

let map;
let marker;

function initMap() {
    if (typeof google === 'undefined' || !google.maps) {
        console.error('Google Maps API not loaded');
        return;
    }
    
    const defaultLocation = { lat: 24.8607, lng: 67.0011 }; // Karachi, Pakistan
    
    map = new google.maps.Map(document.getElementById('map-container'), {
        center: defaultLocation,
        zoom: 13,
        styles: [
            {
                featureType: 'all',
                elementType: 'geometry',
                stylers: [{ color: '#f5f5f7' }]
            }
        ]
    });

    marker = new google.maps.Marker({
        position: defaultLocation,
        map: map,
        draggable: true
    });

    map.addListener('click', function(e) {
        marker.setPosition(e.latLng);
        updateCoordinates(e.latLng.lat(), e.latLng.lng());
    });

    marker.addListener('dragend', function(e) {
        updateCoordinates(e.latLng.lat(), e.latLng.lng());
    });

    updateCoordinates(defaultLocation.lat, defaultLocation.lng);
}

function updateCoordinates(lat, lng) {
    document.getElementById('selected_lat').value = lat;
    document.getElementById('selected_lng').value = lng;
}

// Initialize map on page load if map option is active
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('map-option') && !document.getElementById('map-option').classList.contains('hidden')) {
        if (typeof google !== 'undefined' && google.maps) {
            initMap();
        } else {
            // Load Google Maps API
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY|default:'' }}&callback=initMap`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }
    }
});
</script>

{% if GOOGLE_MAPS_API_KEY %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap" async defer></script>
{% endif %}

{% endblock %}
